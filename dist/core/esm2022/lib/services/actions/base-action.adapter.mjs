/**
 * SuiteCRM is a customer relationship management program developed by SalesAgility Ltd.
 * Copyright (C) 2021 SalesAgility Ltd.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License version 3 as published by the
 * Free Software Foundation with the addition of the following permission added
 * to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK
 * IN WHICH THE COPYRIGHT IS OWNED BY SALESAGILITY, SALESAGILITY DISCLAIMS THE
 * WARRANTY OF NON INFRINGEMENT OF THIRD PARTY RIGHTS.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * In accordance with Section 7(b) of the GNU Affero General Public License
 * version 3, these Appropriate Legal Notices must retain the display of the
 * "Supercharged by SuiteCRM" logo. If the display of the logos is not reasonably
 * feasible for technical reasons, the Appropriate Legal Notices must display
 * the words "Supercharged by SuiteCRM".
 */
import { take } from 'rxjs/operators';
export class BaseActionsAdapter {
    actionManager;
    asyncActionService;
    message;
    confirmation;
    language;
    selectModalService;
    metadata;
    defaultActions = {
        detail: [],
        list: [],
        edit: [],
        create: [],
        massupdate: []
    };
    constructor(actionManager, asyncActionService, message, confirmation, language, selectModalService, metadata) {
        this.actionManager = actionManager;
        this.asyncActionService = asyncActionService;
        this.message = message;
        this.confirmation = confirmation;
        this.language = language;
        this.selectModalService = selectModalService;
        this.metadata = metadata;
    }
    /**
     * Run the action using given context
     * @param action
     * @param context
     */
    runAction(action, context = null) {
        const params = (action && action.params) || {};
        const displayConfirmation = params.displayConfirmation || false;
        const confirmationLabel = params.confirmationLabel || '';
        const selectModal = action.params && action.params.selectModal;
        const selectModule = selectModal && selectModal.module;
        if (displayConfirmation) {
            this.confirmation.showModal(confirmationLabel, () => {
                if (!selectModule) {
                    this.callAction(action, context);
                    return;
                }
                this.showSelectModal(selectModal.module, action, context);
            });
            return;
        }
        if (!selectModule) {
            this.callAction(action, context);
            return;
        }
        this.showSelectModal(selectModal.module, action, context);
    }
    /**
     * Run async buk action
     *
     * @returns void
     * @param {string} selectModule: module for which records are listed in Select Modal/Popup
     * @param {string} asyncAction: bulk action name
     * @param {ActionContext} context
     */
    showSelectModal(selectModule, asyncAction, context = null) {
        this.selectModalService.showSelectModal(selectModule, (modalRecord) => {
            if (modalRecord) {
                const { fields, formGroup, ...baseRecord } = modalRecord;
                asyncAction.params.modalRecord = baseRecord;
            }
            this.callAction(asyncAction, context);
        });
    }
    /**
     * Get action name
     * @param action
     */
    getActionName(action) {
        return `${action.key}`;
    }
    /**
     * Parse mode actions
     * @param declaredActions
     * @param mode
     * @param context
     */
    parseModeActions(declaredActions, mode, context = null) {
        if (!declaredActions) {
            return [];
        }
        const availableActions = {
            list: [],
            detail: [],
            edit: [],
            create: [],
            massupdate: [],
        };
        if (declaredActions && declaredActions.length) {
            declaredActions.forEach(action => {
                if (!action.modes || !action.modes.length) {
                    return;
                }
                action.modes.forEach(actionMode => {
                    if (!availableActions[actionMode] && !action.asyncProcess) {
                        return;
                    }
                    availableActions[actionMode].push(action);
                });
            });
        }
        availableActions.detail = availableActions.detail.concat(this.defaultActions.detail ?? []);
        availableActions.list = availableActions.list.concat(this.defaultActions.list ?? []);
        availableActions.edit = availableActions.edit.concat(this.defaultActions.edit ?? []);
        availableActions.create = availableActions.create.concat(this.defaultActions.create ?? []);
        availableActions.massupdate = availableActions.massupdate.concat(this.defaultActions.massupdate ?? []);
        const actions = [];
        availableActions[mode].forEach(action => {
            const actionHandler = this.actionManager.getHandler(action, mode);
            if (actionHandler) {
                const data = this.buildActionData(action, context);
                if (!this.shouldDisplay(actionHandler, data)) {
                    return;
                }
                action.status = actionHandler.getStatus(data) || '';
            }
            const module = (context && context.module) || '';
            const label = this.language.getFieldLabel(action.labelKey, module);
            actions.push({
                ...action,
                label
            });
        });
        return actions;
    }
    shouldDisplay(actionHandler, data) {
        return actionHandler && actionHandler.shouldDisplay(data);
    }
    /**
     * Call actions
     * @param action
     * @param context
     */
    callAction(action, context = null) {
        if (action.asyncProcess) {
            this.runAsyncAction(action, context);
            return;
        }
        this.runFrontEndAction(action, context);
    }
    /**
     * Run async actions
     * @param action
     * @param context
     */
    runAsyncAction(action, context = null) {
        const actionName = this.getActionName(action);
        const moduleName = this.getModuleName(context);
        this.message.removeMessages();
        const asyncData = this.buildActionInput(action, actionName, moduleName, context);
        this.asyncActionService.run(actionName, asyncData).pipe(take(1)).subscribe((process) => {
            this.afterAsyncAction(actionName, moduleName, asyncData, process, action, context);
        });
    }
    /**
     * Run after async action handlers
     * @param actionName
     * @param moduleName
     * @param asyncData
     * @param process
     * @param action
     * @param context
     * @protected
     */
    afterAsyncAction(actionName, moduleName, asyncData, process, action, context) {
        if (this.shouldReload(process)) {
            this.reload(action, process, context);
        }
        this.reloadMetadata(moduleName, action, process, context);
    }
    /**
     * Reload the metadata for the module
     * @param moduleName
     * @param action
     * @param process
     * @param context
     * @protected
     */
    reloadMetadata(moduleName, action, process, context) {
        const typesToLoad = [];
        if (this.shouldReloadRecentlyViewed(process)) {
            typesToLoad.push(this.metadata.typeKeys.recentlyViewed);
        }
        if (this.shouldReloadFavorites(process)) {
            typesToLoad.push(this.metadata.typeKeys.favorites);
        }
        if (typesToLoad && typesToLoad.length) {
            this.metadata.reloadModuleMetadata(moduleName, typesToLoad, false).pipe(take(1)).subscribe();
        }
    }
    /**
     * Should reload page
     * @param process
     */
    shouldReloadRecentlyViewed(process) {
        return !!(process.data && process.data.reloadRecentlyViewed);
    }
    /**
     * Should reload page
     * @param process
     */
    shouldReloadFavorites(process) {
        return !!(process.data && process.data.reloadFavorites);
    }
    /**
     * Should reload page
     * @param process
     */
    shouldReload(process) {
        return !!(process.data && process.data.reload);
    }
    /**
     * Run front end action
     * @param action
     * @param context
     */
    runFrontEndAction(action, context = null) {
        const data = this.buildActionData(action, context);
        this.actionManager.run(action, this.getMode(), data);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1hY3Rpb24uYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2NvcmUvYXBwL2NvcmUvc3JjL2xpYi9zZXJ2aWNlcy9hY3Rpb25zL2Jhc2UtYWN0aW9uLmFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXdCRztBQWNILE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQVNwQyxNQUFNLE9BQWdCLGtCQUFrQjtJQVd0QjtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWZkLGNBQWMsR0FBZ0I7UUFDMUIsTUFBTSxFQUFFLEVBQUU7UUFDVixJQUFJLEVBQUUsRUFBRTtRQUNSLElBQUksRUFBRSxFQUFFO1FBQ1IsTUFBTSxFQUFFLEVBQUU7UUFDVixVQUFVLEVBQUUsRUFBRTtLQUNqQixDQUFDO0lBRUYsWUFDYyxhQUErQixFQUMvQixrQkFBc0MsRUFDdEMsT0FBdUIsRUFDdkIsWUFBc0MsRUFDdEMsUUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLFFBQXVCO1FBTnZCLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUMvQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLGlCQUFZLEdBQVosWUFBWSxDQUEwQjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFlO1FBQ3ZCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsYUFBUSxHQUFSLFFBQVEsQ0FBZTtJQUVyQyxDQUFDO0lBWUQ7Ozs7T0FJRztJQUNILFNBQVMsQ0FBQyxNQUFjLEVBQUUsVUFBeUIsSUFBSTtRQUNuRCxNQUFNLE1BQU0sR0FBRyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBNEIsQ0FBQztRQUN6RSxNQUFNLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxtQkFBbUIsSUFBSSxLQUFLLENBQUM7UUFDaEUsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsaUJBQWlCLElBQUksRUFBRSxDQUFDO1FBRXpELE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDL0QsTUFBTSxZQUFZLEdBQUcsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFFdkQsSUFBSSxtQkFBbUIsRUFBRTtZQUNyQixJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7Z0JBQ2hELElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBQ2pDLE9BQU87aUJBQ1Y7Z0JBQ0QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUM5RCxDQUFDLENBQUMsQ0FBQztZQUVILE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDZixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNqQyxPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ksZUFBZSxDQUFDLFlBQW9CLEVBQUUsV0FBbUIsRUFBRSxVQUF5QixJQUFJO1FBRTNGLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLENBQUMsV0FBbUIsRUFBRSxFQUFFO1lBQzFFLElBQUksV0FBVyxFQUFFO2dCQUNiLE1BQU0sRUFBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsVUFBVSxFQUFDLEdBQUcsV0FBVyxDQUFDO2dCQUN2RCxXQUFXLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUM7YUFDL0M7WUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFhRDs7O09BR0c7SUFDTyxhQUFhLENBQUMsTUFBYztRQUNsQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNPLGdCQUFnQixDQUFDLGVBQXlCLEVBQUUsSUFBYyxFQUFFLFVBQXlCLElBQUk7UUFDL0YsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNsQixPQUFPLEVBQUUsQ0FBQztTQUNiO1FBRUQsTUFBTSxnQkFBZ0IsR0FBRztZQUNyQixJQUFJLEVBQUUsRUFBRTtZQUNSLE1BQU0sRUFBRSxFQUFFO1lBQ1YsSUFBSSxFQUFFLEVBQUU7WUFDUixNQUFNLEVBQUUsRUFBRTtZQUNWLFVBQVUsRUFBRSxFQUFFO1NBQ0YsQ0FBQztRQUVqQixJQUFJLGVBQWUsSUFBSSxlQUFlLENBQUMsTUFBTSxFQUFFO1lBQzNDLGVBQWUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7b0JBQ3ZDLE9BQU87aUJBQ1Y7Z0JBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUU7b0JBQzlCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7d0JBQ3ZELE9BQU87cUJBQ1Y7b0JBQ0QsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzRixnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNyRixnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNyRixnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzRixnQkFBZ0IsQ0FBQyxVQUFVLEdBQUcsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUV2RyxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDbkIsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBRXBDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUVsRSxJQUFJLGFBQWEsRUFBRTtnQkFDZixNQUFNLElBQUksR0FBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFFdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxFQUFFO29CQUMxQyxPQUFPO2lCQUNWO2dCQUVELE1BQU0sQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDdkQ7WUFFRCxNQUFNLE1BQU0sR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2pELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDbkUsT0FBTyxDQUFDLElBQUksQ0FBQztnQkFDVCxHQUFHLE1BQU07Z0JBQ1QsS0FBSzthQUNSLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVTLGFBQWEsQ0FBQyxhQUErQixFQUFFLElBQU87UUFFNUQsT0FBTyxhQUFhLElBQUksYUFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNPLFVBQVUsQ0FBQyxNQUFjLEVBQUUsVUFBeUIsSUFBSTtRQUM5RCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDckMsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNPLGNBQWMsQ0FBQyxNQUFjLEVBQUUsVUFBeUIsSUFBSTtRQUNsRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFL0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUM5QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFakYsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQWdCLEVBQUUsRUFBRTtZQUM1RixJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN2RixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDTyxnQkFBZ0IsQ0FDdEIsVUFBa0IsRUFDbEIsVUFBa0IsRUFDbEIsU0FBMkIsRUFDM0IsT0FBZ0IsRUFDaEIsTUFBYyxFQUNkLE9BQXNCO1FBRXRCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDekM7UUFFRCxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ08sY0FBYyxDQUFDLFVBQWtCLEVBQUUsTUFBYyxFQUFFLE9BQWdCLEVBQUUsT0FBdUI7UUFDbEcsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBRXZCLElBQUksSUFBSSxDQUFDLDBCQUEwQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUM7U0FDM0Q7UUFFRCxJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNyQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3REO1FBRUQsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsRUFBRSxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2hHO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNPLDBCQUEwQixDQUFDLE9BQWdCO1FBQ2pELE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVEOzs7T0FHRztJQUNPLHFCQUFxQixDQUFDLE9BQWdCO1FBQzVDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRDs7O09BR0c7SUFDTyxZQUFZLENBQUMsT0FBZ0I7UUFDbkMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVEOzs7O09BSUc7SUFDTyxpQkFBaUIsQ0FBQyxNQUFjLEVBQUUsVUFBeUIsSUFBSTtRQUNyRSxNQUFNLElBQUksR0FBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUV0RCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3pELENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3VpdGVDUk0gaXMgYSBjdXN0b21lciByZWxhdGlvbnNoaXAgbWFuYWdlbWVudCBwcm9ncmFtIGRldmVsb3BlZCBieSBTYWxlc0FnaWxpdHkgTHRkLlxuICogQ29weXJpZ2h0IChDKSAyMDIxIFNhbGVzQWdpbGl0eSBMdGQuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXJcbiAqIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIHZlcnNpb24gMyBhcyBwdWJsaXNoZWQgYnkgdGhlXG4gKiBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24gd2l0aCB0aGUgYWRkaXRpb24gb2YgdGhlIGZvbGxvd2luZyBwZXJtaXNzaW9uIGFkZGVkXG4gKiB0byBTZWN0aW9uIDE1IGFzIHBlcm1pdHRlZCBpbiBTZWN0aW9uIDcoYSk6IEZPUiBBTlkgUEFSVCBPRiBUSEUgQ09WRVJFRCBXT1JLXG4gKiBJTiBXSElDSCBUSEUgQ09QWVJJR0hUIElTIE9XTkVEIEJZIFNBTEVTQUdJTElUWSwgU0FMRVNBR0lMSVRZIERJU0NMQUlNUyBUSEVcbiAqIFdBUlJBTlRZIE9GIE5PTiBJTkZSSU5HRU1FTlQgT0YgVEhJUkQgUEFSVFkgUklHSFRTLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVFxuICogQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1NcbiAqIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmVcbiAqIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqXG4gKiBJbiBhY2NvcmRhbmNlIHdpdGggU2VjdGlvbiA3KGIpIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIHZlcnNpb24gMywgdGhlc2UgQXBwcm9wcmlhdGUgTGVnYWwgTm90aWNlcyBtdXN0IHJldGFpbiB0aGUgZGlzcGxheSBvZiB0aGVcbiAqIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIgbG9nby4gSWYgdGhlIGRpc3BsYXkgb2YgdGhlIGxvZ29zIGlzIG5vdCByZWFzb25hYmx5XG4gKiBmZWFzaWJsZSBmb3IgdGVjaG5pY2FsIHJlYXNvbnMsIHRoZSBBcHByb3ByaWF0ZSBMZWdhbCBOb3RpY2VzIG11c3QgZGlzcGxheVxuICogdGhlIHdvcmRzIFwiU3VwZXJjaGFyZ2VkIGJ5IFN1aXRlQ1JNXCIuXG4gKi9cblxuaW1wb3J0IHtcbiAgICBBY3Rpb24sXG4gICAgQWN0aW9uQ29udGV4dCxcbiAgICBBY3Rpb25EYXRhLFxuICAgIEFjdGlvbkRhdGFTb3VyY2UsXG4gICAgQWN0aW9uSGFuZGxlcixcbiAgICBBY3Rpb25NYW5hZ2VyLFxuICAgIE1vZGVBY3Rpb25zLFxuICAgIFJlY29yZCxcbiAgICBWaWV3TW9kZVxufSBmcm9tICdjb21tb24nO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7dGFrZX0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtBc3luY0FjdGlvbklucHV0LCBBc3luY0FjdGlvblNlcnZpY2V9IGZyb20gJy4uL3Byb2Nlc3MvcHJvY2Vzc2VzL2FzeW5jLWFjdGlvbi9hc3luYy1hY3Rpb24nO1xuaW1wb3J0IHtNZXNzYWdlU2VydmljZX0gZnJvbSAnLi4vbWVzc2FnZS9tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHtQcm9jZXNzfSBmcm9tICcuLi9wcm9jZXNzL3Byb2Nlc3Muc2VydmljZSc7XG5pbXBvcnQge0NvbmZpcm1hdGlvbk1vZGFsU2VydmljZX0gZnJvbSAnLi4vbW9kYWxzL2NvbmZpcm1hdGlvbi1tb2RhbC5zZXJ2aWNlJztcbmltcG9ydCB7TGFuZ3VhZ2VTdG9yZX0gZnJvbSAnLi4vLi4vc3RvcmUvbGFuZ3VhZ2UvbGFuZ3VhZ2Uuc3RvcmUnO1xuaW1wb3J0IHtTZWxlY3RNb2RhbFNlcnZpY2V9IGZyb20gJy4uL21vZGFscy9zZWxlY3QtbW9kYWwuc2VydmljZSc7XG5pbXBvcnQge01ldGFkYXRhU3RvcmV9IGZyb20gJy4uLy4uL3N0b3JlL21ldGFkYXRhL21ldGFkYXRhLnN0b3JlLnNlcnZpY2UnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZUFjdGlvbnNBZGFwdGVyPEQgZXh0ZW5kcyBBY3Rpb25EYXRhPiBpbXBsZW1lbnRzIEFjdGlvbkRhdGFTb3VyY2Uge1xuXG4gICAgZGVmYXVsdEFjdGlvbnM6IE1vZGVBY3Rpb25zID0ge1xuICAgICAgICBkZXRhaWw6IFtdLFxuICAgICAgICBsaXN0OiBbXSxcbiAgICAgICAgZWRpdDogW10sXG4gICAgICAgIGNyZWF0ZTogW10sXG4gICAgICAgIG1hc3N1cGRhdGU6IFtdXG4gICAgfTtcblxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIGFjdGlvbk1hbmFnZXI6IEFjdGlvbk1hbmFnZXI8RD4sXG4gICAgICAgIHByb3RlY3RlZCBhc3luY0FjdGlvblNlcnZpY2U6IEFzeW5jQWN0aW9uU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIG1lc3NhZ2U6IE1lc3NhZ2VTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgY29uZmlybWF0aW9uOiBDb25maXJtYXRpb25Nb2RhbFNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBsYW5ndWFnZTogTGFuZ3VhZ2VTdG9yZSxcbiAgICAgICAgcHJvdGVjdGVkIHNlbGVjdE1vZGFsU2VydmljZTogU2VsZWN0TW9kYWxTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgbWV0YWRhdGE6IE1ldGFkYXRhU3RvcmVcbiAgICApIHtcbiAgICB9XG5cbiAgICBhYnN0cmFjdCBnZXRBY3Rpb25zKGNvbnRleHQ/OiBBY3Rpb25Db250ZXh0KTogT2JzZXJ2YWJsZTxBY3Rpb25bXT47XG5cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0TW9kdWxlTmFtZShjb250ZXh0PzogQWN0aW9uQ29udGV4dCk6IHN0cmluZztcblxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCByZWxvYWQoYWN0aW9uOiBBY3Rpb24sIHByb2Nlc3M6IFByb2Nlc3MsIGNvbnRleHQ/OiBBY3Rpb25Db250ZXh0KTogdm9pZDtcblxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRNb2RlKCk6IFZpZXdNb2RlO1xuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGJ1aWxkQWN0aW9uRGF0YShhY3Rpb246IEFjdGlvbiwgY29udGV4dD86IEFjdGlvbkNvbnRleHQpOiBEO1xuXG4gICAgLyoqXG4gICAgICogUnVuIHRoZSBhY3Rpb24gdXNpbmcgZ2l2ZW4gY29udGV4dFxuICAgICAqIEBwYXJhbSBhY3Rpb25cbiAgICAgKiBAcGFyYW0gY29udGV4dFxuICAgICAqL1xuICAgIHJ1bkFjdGlvbihhY3Rpb246IEFjdGlvbiwgY29udGV4dDogQWN0aW9uQ29udGV4dCA9IG51bGwpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gKGFjdGlvbiAmJiBhY3Rpb24ucGFyYW1zKSB8fCB7fSBhcyB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuICAgICAgICBjb25zdCBkaXNwbGF5Q29uZmlybWF0aW9uID0gcGFyYW1zLmRpc3BsYXlDb25maXJtYXRpb24gfHwgZmFsc2U7XG4gICAgICAgIGNvbnN0IGNvbmZpcm1hdGlvbkxhYmVsID0gcGFyYW1zLmNvbmZpcm1hdGlvbkxhYmVsIHx8ICcnO1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdE1vZGFsID0gYWN0aW9uLnBhcmFtcyAmJiBhY3Rpb24ucGFyYW1zLnNlbGVjdE1vZGFsO1xuICAgICAgICBjb25zdCBzZWxlY3RNb2R1bGUgPSBzZWxlY3RNb2RhbCAmJiBzZWxlY3RNb2RhbC5tb2R1bGU7XG5cbiAgICAgICAgaWYgKGRpc3BsYXlDb25maXJtYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlybWF0aW9uLnNob3dNb2RhbChjb25maXJtYXRpb25MYWJlbCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghc2VsZWN0TW9kdWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FsbEFjdGlvbihhY3Rpb24sIGNvbnRleHQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlbGVjdE1vZGFsKHNlbGVjdE1vZGFsLm1vZHVsZSwgYWN0aW9uLCBjb250ZXh0KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXNlbGVjdE1vZHVsZSkge1xuICAgICAgICAgICAgdGhpcy5jYWxsQWN0aW9uKGFjdGlvbiwgY29udGV4dCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNob3dTZWxlY3RNb2RhbChzZWxlY3RNb2RhbC5tb2R1bGUsIGFjdGlvbiwgY29udGV4dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVuIGFzeW5jIGJ1ayBhY3Rpb25cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHZvaWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0TW9kdWxlOiBtb2R1bGUgZm9yIHdoaWNoIHJlY29yZHMgYXJlIGxpc3RlZCBpbiBTZWxlY3QgTW9kYWwvUG9wdXBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXN5bmNBY3Rpb246IGJ1bGsgYWN0aW9uIG5hbWVcbiAgICAgKiBAcGFyYW0ge0FjdGlvbkNvbnRleHR9IGNvbnRleHRcbiAgICAgKi9cbiAgICBwdWJsaWMgc2hvd1NlbGVjdE1vZGFsKHNlbGVjdE1vZHVsZTogc3RyaW5nLCBhc3luY0FjdGlvbjogQWN0aW9uLCBjb250ZXh0OiBBY3Rpb25Db250ZXh0ID0gbnVsbCkge1xuXG4gICAgICAgIHRoaXMuc2VsZWN0TW9kYWxTZXJ2aWNlLnNob3dTZWxlY3RNb2RhbChzZWxlY3RNb2R1bGUsIChtb2RhbFJlY29yZDogUmVjb3JkKSA9PiB7XG4gICAgICAgICAgICBpZiAobW9kYWxSZWNvcmQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB7ZmllbGRzLCBmb3JtR3JvdXAsIC4uLmJhc2VSZWNvcmR9ID0gbW9kYWxSZWNvcmQ7XG4gICAgICAgICAgICAgICAgYXN5bmNBY3Rpb24ucGFyYW1zLm1vZGFsUmVjb3JkID0gYmFzZVJlY29yZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2FsbEFjdGlvbihhc3luY0FjdGlvbiwgY29udGV4dCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJ1aWxkIGFzeW5jIHByb2Nlc3MgaW5wdXRcbiAgICAgKiBAcGFyYW0gYWN0aW9uXG4gICAgICogQHBhcmFtIGFjdGlvbk5hbWVcbiAgICAgKiBAcGFyYW0gbW9kdWxlTmFtZVxuICAgICAqIEBwYXJhbSBjb250ZXh0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGJ1aWxkQWN0aW9uSW5wdXQoYWN0aW9uOiBBY3Rpb24sIGFjdGlvbk5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dD86IEFjdGlvbkNvbnRleHQpOiBBc3luY0FjdGlvbklucHV0O1xuXG4gICAgLyoqXG4gICAgICogR2V0IGFjdGlvbiBuYW1lXG4gICAgICogQHBhcmFtIGFjdGlvblxuICAgICAqL1xuICAgIHByb3RlY3RlZCBnZXRBY3Rpb25OYW1lKGFjdGlvbjogQWN0aW9uKSB7XG4gICAgICAgIHJldHVybiBgJHthY3Rpb24ua2V5fWA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUGFyc2UgbW9kZSBhY3Rpb25zXG4gICAgICogQHBhcmFtIGRlY2xhcmVkQWN0aW9uc1xuICAgICAqIEBwYXJhbSBtb2RlXG4gICAgICogQHBhcmFtIGNvbnRleHRcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgcGFyc2VNb2RlQWN0aW9ucyhkZWNsYXJlZEFjdGlvbnM6IEFjdGlvbltdLCBtb2RlOiBWaWV3TW9kZSwgY29udGV4dDogQWN0aW9uQ29udGV4dCA9IG51bGwpIHtcbiAgICAgICAgaWYgKCFkZWNsYXJlZEFjdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGF2YWlsYWJsZUFjdGlvbnMgPSB7XG4gICAgICAgICAgICBsaXN0OiBbXSxcbiAgICAgICAgICAgIGRldGFpbDogW10sXG4gICAgICAgICAgICBlZGl0OiBbXSxcbiAgICAgICAgICAgIGNyZWF0ZTogW10sXG4gICAgICAgICAgICBtYXNzdXBkYXRlOiBbXSxcbiAgICAgICAgfSBhcyBNb2RlQWN0aW9ucztcblxuICAgICAgICBpZiAoZGVjbGFyZWRBY3Rpb25zICYmIGRlY2xhcmVkQWN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGRlY2xhcmVkQWN0aW9ucy5mb3JFYWNoKGFjdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpb24ubW9kZXMgfHwgIWFjdGlvbi5tb2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGFjdGlvbi5tb2Rlcy5mb3JFYWNoKGFjdGlvbk1vZGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWF2YWlsYWJsZUFjdGlvbnNbYWN0aW9uTW9kZV0gJiYgIWFjdGlvbi5hc3luY1Byb2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVBY3Rpb25zW2FjdGlvbk1vZGVdLnB1c2goYWN0aW9uKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgYXZhaWxhYmxlQWN0aW9ucy5kZXRhaWwgPSBhdmFpbGFibGVBY3Rpb25zLmRldGFpbC5jb25jYXQodGhpcy5kZWZhdWx0QWN0aW9ucy5kZXRhaWwgPz8gW10pO1xuICAgICAgICBhdmFpbGFibGVBY3Rpb25zLmxpc3QgPSBhdmFpbGFibGVBY3Rpb25zLmxpc3QuY29uY2F0KHRoaXMuZGVmYXVsdEFjdGlvbnMubGlzdCA/PyBbXSk7XG4gICAgICAgIGF2YWlsYWJsZUFjdGlvbnMuZWRpdCA9IGF2YWlsYWJsZUFjdGlvbnMuZWRpdC5jb25jYXQodGhpcy5kZWZhdWx0QWN0aW9ucy5lZGl0ID8/IFtdKTtcbiAgICAgICAgYXZhaWxhYmxlQWN0aW9ucy5jcmVhdGUgPSBhdmFpbGFibGVBY3Rpb25zLmNyZWF0ZS5jb25jYXQodGhpcy5kZWZhdWx0QWN0aW9ucy5jcmVhdGUgPz8gW10pO1xuICAgICAgICBhdmFpbGFibGVBY3Rpb25zLm1hc3N1cGRhdGUgPSBhdmFpbGFibGVBY3Rpb25zLm1hc3N1cGRhdGUuY29uY2F0KHRoaXMuZGVmYXVsdEFjdGlvbnMubWFzc3VwZGF0ZSA/PyBbXSk7XG5cbiAgICAgICAgY29uc3QgYWN0aW9ucyA9IFtdO1xuICAgICAgICBhdmFpbGFibGVBY3Rpb25zW21vZGVdLmZvckVhY2goYWN0aW9uID0+IHtcblxuICAgICAgICAgICAgY29uc3QgYWN0aW9uSGFuZGxlciA9IHRoaXMuYWN0aW9uTWFuYWdlci5nZXRIYW5kbGVyKGFjdGlvbiwgbW9kZSk7XG5cbiAgICAgICAgICAgIGlmIChhY3Rpb25IYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YTogRCA9IHRoaXMuYnVpbGRBY3Rpb25EYXRhKGFjdGlvbiwgY29udGV4dCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkRGlzcGxheShhY3Rpb25IYW5kbGVyLCBkYXRhKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgYWN0aW9uLnN0YXR1cyA9IGFjdGlvbkhhbmRsZXIuZ2V0U3RhdHVzKGRhdGEpIHx8ICcnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBtb2R1bGUgPSAoY29udGV4dCAmJiBjb250ZXh0Lm1vZHVsZSkgfHwgJyc7XG4gICAgICAgICAgICBjb25zdCBsYWJlbCA9IHRoaXMubGFuZ3VhZ2UuZ2V0RmllbGRMYWJlbChhY3Rpb24ubGFiZWxLZXksIG1vZHVsZSk7XG4gICAgICAgICAgICBhY3Rpb25zLnB1c2goe1xuICAgICAgICAgICAgICAgIC4uLmFjdGlvbixcbiAgICAgICAgICAgICAgICBsYWJlbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhY3Rpb25zO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzaG91bGREaXNwbGF5KGFjdGlvbkhhbmRsZXI6IEFjdGlvbkhhbmRsZXI8RD4sIGRhdGE6IEQpOiBib29sZWFuIHtcblxuICAgICAgICByZXR1cm4gYWN0aW9uSGFuZGxlciAmJiBhY3Rpb25IYW5kbGVyLnNob3VsZERpc3BsYXkoZGF0YSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsbCBhY3Rpb25zXG4gICAgICogQHBhcmFtIGFjdGlvblxuICAgICAqIEBwYXJhbSBjb250ZXh0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIGNhbGxBY3Rpb24oYWN0aW9uOiBBY3Rpb24sIGNvbnRleHQ6IEFjdGlvbkNvbnRleHQgPSBudWxsKSB7XG4gICAgICAgIGlmIChhY3Rpb24uYXN5bmNQcm9jZXNzKSB7XG4gICAgICAgICAgICB0aGlzLnJ1bkFzeW5jQWN0aW9uKGFjdGlvbiwgY29udGV4dCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ydW5Gcm9udEVuZEFjdGlvbihhY3Rpb24sIGNvbnRleHQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1biBhc3luYyBhY3Rpb25zXG4gICAgICogQHBhcmFtIGFjdGlvblxuICAgICAqIEBwYXJhbSBjb250ZXh0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIHJ1bkFzeW5jQWN0aW9uKGFjdGlvbjogQWN0aW9uLCBjb250ZXh0OiBBY3Rpb25Db250ZXh0ID0gbnVsbCk6IHZvaWQge1xuICAgICAgICBjb25zdCBhY3Rpb25OYW1lID0gdGhpcy5nZXRBY3Rpb25OYW1lKGFjdGlvbik7XG4gICAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSB0aGlzLmdldE1vZHVsZU5hbWUoY29udGV4dCk7XG5cbiAgICAgICAgdGhpcy5tZXNzYWdlLnJlbW92ZU1lc3NhZ2VzKCk7XG4gICAgICAgIGNvbnN0IGFzeW5jRGF0YSA9IHRoaXMuYnVpbGRBY3Rpb25JbnB1dChhY3Rpb24sIGFjdGlvbk5hbWUsIG1vZHVsZU5hbWUsIGNvbnRleHQpO1xuXG4gICAgICAgIHRoaXMuYXN5bmNBY3Rpb25TZXJ2aWNlLnJ1bihhY3Rpb25OYW1lLCBhc3luY0RhdGEpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKChwcm9jZXNzOiBQcm9jZXNzKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFmdGVyQXN5bmNBY3Rpb24oYWN0aW9uTmFtZSwgbW9kdWxlTmFtZSwgYXN5bmNEYXRhLCBwcm9jZXNzLCBhY3Rpb24sIGNvbnRleHQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW4gYWZ0ZXIgYXN5bmMgYWN0aW9uIGhhbmRsZXJzXG4gICAgICogQHBhcmFtIGFjdGlvbk5hbWVcbiAgICAgKiBAcGFyYW0gbW9kdWxlTmFtZVxuICAgICAqIEBwYXJhbSBhc3luY0RhdGFcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc1xuICAgICAqIEBwYXJhbSBhY3Rpb25cbiAgICAgKiBAcGFyYW0gY29udGV4dFxuICAgICAqIEBwcm90ZWN0ZWRcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgYWZ0ZXJBc3luY0FjdGlvbihcbiAgICAgICAgYWN0aW9uTmFtZTogc3RyaW5nLFxuICAgICAgICBtb2R1bGVOYW1lOiBzdHJpbmcsXG4gICAgICAgIGFzeW5jRGF0YTogQXN5bmNBY3Rpb25JbnB1dCxcbiAgICAgICAgcHJvY2VzczogUHJvY2VzcyxcbiAgICAgICAgYWN0aW9uOiBBY3Rpb24sXG4gICAgICAgIGNvbnRleHQ6IEFjdGlvbkNvbnRleHRcbiAgICApIHtcbiAgICAgICAgaWYgKHRoaXMuc2hvdWxkUmVsb2FkKHByb2Nlc3MpKSB7XG4gICAgICAgICAgICB0aGlzLnJlbG9hZChhY3Rpb24sIHByb2Nlc3MsIGNvbnRleHQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZWxvYWRNZXRhZGF0YShtb2R1bGVOYW1lLCBhY3Rpb24sIHByb2Nlc3MsIGNvbnRleHQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbG9hZCB0aGUgbWV0YWRhdGEgZm9yIHRoZSBtb2R1bGVcbiAgICAgKiBAcGFyYW0gbW9kdWxlTmFtZVxuICAgICAqIEBwYXJhbSBhY3Rpb25cbiAgICAgKiBAcGFyYW0gcHJvY2Vzc1xuICAgICAqIEBwYXJhbSBjb250ZXh0XG4gICAgICogQHByb3RlY3RlZFxuICAgICAqL1xuICAgIHByb3RlY3RlZCByZWxvYWRNZXRhZGF0YShtb2R1bGVOYW1lOiBzdHJpbmcsIGFjdGlvbjogQWN0aW9uLCBwcm9jZXNzOiBQcm9jZXNzLCBjb250ZXh0PzogQWN0aW9uQ29udGV4dCk6IHZvaWQge1xuICAgICAgICBjb25zdCB0eXBlc1RvTG9hZCA9IFtdO1xuXG4gICAgICAgIGlmICh0aGlzLnNob3VsZFJlbG9hZFJlY2VudGx5Vmlld2VkKHByb2Nlc3MpKSB7XG4gICAgICAgICAgICB0eXBlc1RvTG9hZC5wdXNoKHRoaXMubWV0YWRhdGEudHlwZUtleXMucmVjZW50bHlWaWV3ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc2hvdWxkUmVsb2FkRmF2b3JpdGVzKHByb2Nlc3MpKSB7XG4gICAgICAgICAgICB0eXBlc1RvTG9hZC5wdXNoKHRoaXMubWV0YWRhdGEudHlwZUtleXMuZmF2b3JpdGVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlc1RvTG9hZCAmJiB0eXBlc1RvTG9hZC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMubWV0YWRhdGEucmVsb2FkTW9kdWxlTWV0YWRhdGEobW9kdWxlTmFtZSwgdHlwZXNUb0xvYWQsIGZhbHNlKS5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2hvdWxkIHJlbG9hZCBwYWdlXG4gICAgICogQHBhcmFtIHByb2Nlc3NcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgc2hvdWxkUmVsb2FkUmVjZW50bHlWaWV3ZWQocHJvY2VzczogUHJvY2Vzcyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISEocHJvY2Vzcy5kYXRhICYmIHByb2Nlc3MuZGF0YS5yZWxvYWRSZWNlbnRseVZpZXdlZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2hvdWxkIHJlbG9hZCBwYWdlXG4gICAgICogQHBhcmFtIHByb2Nlc3NcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgc2hvdWxkUmVsb2FkRmF2b3JpdGVzKHByb2Nlc3M6IFByb2Nlc3MpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhKHByb2Nlc3MuZGF0YSAmJiBwcm9jZXNzLmRhdGEucmVsb2FkRmF2b3JpdGVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTaG91bGQgcmVsb2FkIHBhZ2VcbiAgICAgKiBAcGFyYW0gcHJvY2Vzc1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBzaG91bGRSZWxvYWQocHJvY2VzczogUHJvY2Vzcyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISEocHJvY2Vzcy5kYXRhICYmIHByb2Nlc3MuZGF0YS5yZWxvYWQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJ1biBmcm9udCBlbmQgYWN0aW9uXG4gICAgICogQHBhcmFtIGFjdGlvblxuICAgICAqIEBwYXJhbSBjb250ZXh0XG4gICAgICovXG4gICAgcHJvdGVjdGVkIHJ1bkZyb250RW5kQWN0aW9uKGFjdGlvbjogQWN0aW9uLCBjb250ZXh0OiBBY3Rpb25Db250ZXh0ID0gbnVsbCk6IHZvaWQge1xuICAgICAgICBjb25zdCBkYXRhOiBEID0gdGhpcy5idWlsZEFjdGlvbkRhdGEoYWN0aW9uLCBjb250ZXh0KTtcblxuICAgICAgICB0aGlzLmFjdGlvbk1hbmFnZXIucnVuKGFjdGlvbiwgdGhpcy5nZXRNb2RlKCksIGRhdGEpO1xuICAgIH1cbn1cbiJdfQ==